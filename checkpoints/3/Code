python 3 databricks

Command 1

data_allegation_df = spark.read.format('csv').options(header='true', inferSchema='true').load('/FileStore/tables/data_allegation_withyear.csv')
data_officerallegation_df = spark.read.format('csv').options(header='true', inferSchema='true').load('/FileStore/tables/data_officerallegation.csv')
data_officer_df = spark.read.format('csv').options(header='true', inferSchema='true').load('/FileStore/tables/data_officer.csv')
data_investigatorallegation_df = spark.read.format('csv').options(header='true', inferSchema='true').load('/FileStore/tables/data_investigatorallegation.csv')
data_investigator_df = spark.read.format('csv').options(header='true', inferSchema='true').load('/FileStore/tables/data_investigator.csv')
data_victim_df = spark.read.format('csv').options(header='true', inferSchema='true').load('/FileStore/tables/data_victim.csv')
data_complainant_df = spark.read.format('csv').options(header='true', inferSchema='true').load('/FileStore/tables/data_complainant.csv')

Command 2

data_allegation_df.createOrReplaceTempView("data_allegation")
data_officerallegation_df.createOrReplaceTempView("data_officerallegation")
data_officer_df.createOrReplaceTempView("data_officer")
data_investigatorallegation_df.createOrReplaceTempView("data_investigatorallegation")
data_investigator_df.createOrReplaceTempView("data_investigator")
data_victim_df.createOrReplaceTempView("data_victim")
data_complainant_df.createOrReplaceTempView("data_complainant")

Command 3

%sql WITH incidents_byyear AS (SELECT year, race, COUNT(*) AS incident_count

FROM data_officer o JOIN data_officerallegation oa ON o.id = oa.officer_id
JOIN data_allegation a ON a.id = oa.allegation_id
WHERE race != "Unknown"
GROUP BY year, race)

SELECT year, race, incident_count, SUM(incident_count) OVER(PARTITION BY year) as total_incidents, incident_count / SUM(incident_count) OVER(PARTITION BY year) as percentage
FROM incidents_byyear
WHERE year > 1999 AND year < 2018
GROUP BY year, race, incident_count
ORDER BY year, race;

Command 4

%sql WITH countby_race AS (SELECT disciplined, i.race as investigator_race, o.race as officer_race, COUNT(*) as count

FROM data_officerallegation oa JOIN data_allegation a ON oa.allegation_id = a.id
     JOIN  data_investigatorallegation ia ON a.id = ia.allegation_id
     JOIN data_officer o ON  oa.officer_id = o.id
     JOIN data_investigator i ON i.id = ia.investigator_id
WHERE disciplined != ""
GROUP BY disciplined, i.race, o.race),

race_counts AS (SELECT investigator_race as race, SUM(count) as total
FROM countby_race c
WHERE investigator_race = officer_race
GROUP BY investigator_race)

SELECT race, count, total, count/total as pctg
FROM countby_race c, race_counts r
WHERE disciplined = true AND investigator_race = officer_race AND race = investigator_race;

Command 5

%sql WITH countby_race AS (SELECT disciplined, i.race as investigator_race, v.race as victim_race, COUNT(*) as count

FROM data_officerallegation oa JOIN data_allegation a ON oa.allegation_id = a.id
     JOIN  data_investigatorallegation ia ON a.id = ia.allegation_id
     JOIN data_officer o ON  oa.officer_id = o.id
     JOIN data_investigator i ON i.id = ia.investigator_id
     JOIN data_victim v ON v.allegation_id = a.id
WHERE disciplined != ""
GROUP BY disciplined, i.race, v.race),

race_counts AS (SELECT investigator_race as race, SUM(count) as total
FROM countby_race c
WHERE investigator_race = victim_race
GROUP BY investigator_race)

SELECT race, count, total, count/total as pctg
FROM countby_race c, race_counts r
WHERE disciplined = true AND investigator_race = victim_race AND race = investigator_race;

Command 6

%sql WITH countby_race AS (SELECT disciplined, i.race as investigator_race, c.race as complainant_race, COUNT(*) as count

FROM data_officerallegation oa JOIN data_allegation a ON oa.allegation_id = a.id
     JOIN  data_investigatorallegation ia ON a.id = ia.allegation_id
     JOIN data_officer o ON  oa.officer_id = o.id
     JOIN data_investigator i ON i.id = ia.investigator_id
     JOIN data_complainant c ON c.allegation_id = a.id
WHERE disciplined != ""
GROUP BY disciplined, i.race, c.race),

race_counts AS (SELECT investigator_race as race, SUM(count) as total
FROM countby_race
WHERE investigator_race = complainant_race
GROUP BY investigator_race)

SELECT race, count, total, count/total as pctg
FROM countby_race cr, race_counts r
WHERE disciplined = true AND investigator_race = complainant_race AND race = investigator_race;

Command 7

%sql WITH officer_races_byyear AS (SELECT YEAR(o.appointed_date) as appointed_date, o.race, COUNT(*) AS race_count

FROM data_officer o
WHERE o.race != "Unknown"
GROUP BY YEAR(o.appointed_date), o.race)

SELECT appointed_date, race, race_count, SUM(race_count) OVER(PARTITION BY appointed_date) 
as total_races, race_count/SUM(race_count) OVER(PARTITION BY appointed_date) as percentage
FROM officer_races_byyear
WHERE appointed_date >= 2000 AND appointed_date <= 2017
GROUP BY appointed_date, race, race_count
ORDER BY appointed_date, race;

